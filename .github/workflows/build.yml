name: Manual Build (Standard)

# 仅手动触发
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. 从 Makefile 读取 Version 和 Release
    - name: Read Version from Makefile
      id: get_version
      run: |
        # 提取 PKG_VERSION (例如 1.0.0)
        ver=$(grep '^PKG_VERSION:=' Makefile | cut -d'=' -f2 | tr -d '[:space:]')
        # 提取 PKG_RELEASE (例如 1)
        rel=$(grep '^PKG_RELEASE:=' Makefile | cut -d'=' -f2 | tr -d '[:space:]')
        
        echo "Detected: $ver-$rel"
        # 设置环境变量: FULL_VERSION = 1.0.0-1
        echo "FULL_VERSION=$ver-$rel" >> $GITHUB_ENV

    - name: Prepare OpenWrt SDK (x86_64)
      run: |
        sudo apt-get update && sudo apt-get install -y zstd
        wget https://downloads.openwrt.org/releases/24.10.0/targets/x86/64/openwrt-sdk-24.10.0-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
        tar -I zstd -xf openwrt-sdk-*.tar.zst
        rm -f openwrt-sdk-*.tar.zst
        mv openwrt-sdk-* sdk
        
    - name: Update Feeds & Install Package
      run: |
        cd sdk
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ln -s $GITHUB_WORKSPACE package/luci-app-httping

    - name: Compile Package
      run: |
        cd sdk
        make defconfig
        # 编译
        make package/luci-app-httping/compile V=s

    # 2. 发布到 Release
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        # 标签名: v1.0.0-1
        tag_name: v${{ env.FULL_VERSION }}
        # 标题: Release v1.0.0-1
        name: Release v${{ env.FULL_VERSION }}
        # 直接上传标准路径下的文件，不重命名
        # 也就是上传: luci-app-httping_1.0.0-1_all.ipk
        files: sdk/bin/packages/x86_64/base/luci-app-httping_*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}