name: Build httping Package

on:
  push:
    branches:
      - main
    tags:
      - 'v*' # 当你推送 v1.0, v1.0.1 这种标签时触发发布流程
  workflow_dispatch:

permissions:
  contents: write # 必须赋予写权限，否则无法创建 Release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Prepare OpenWrt SDK (x86_64)
      run: |
        wget https://downloads.openwrt.org/releases/23.05.2/targets/x86/64/openwrt-sdk-23.05.2-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        rm -f openwrt-sdk-*.tar.xz
        mv openwrt-sdk-* sdk
        
    - name: Update Feeds & Install Package
      run: |
        cd sdk
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ln -s $GITHUB_WORKSPACE package/luci-app-httping

    - name: Compile Package
      run: |
        cd sdk
        make defconfig
        make package/luci-app-httping/compile V=s

    # 1. 临时保存 (Artifacts) - 用于平时调试
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-httping-ipk
        path: sdk/bin/packages/x86_64/base/luci-app-httping_*.ipk

    # 2. 正式发布 (Release) - 仅在推送标签时运行
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: sdk/bin/packages/x86_64/base/luci-app-httping_*.ipk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}