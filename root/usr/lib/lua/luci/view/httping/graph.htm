<%+header%>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<style>
    /* 容器样式 */
    .toolbar-container {
        background: var(--toolbar-bg, #f8f8f8);
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color, #ddd);
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        box-sizing: border-box;
        width: 100%;
    }

    .chart-wrapper {
        background: var(--chart-bg, #fff);
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color, #ddd);
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
        box-sizing: border-box;
        overflow: hidden;
        width: 100%;
    }

    .chart-div {
        width: 100%;
        min-width: 0;
        height: 500px;
        box-sizing: border-box;
    }

    /* 按钮组与输入框样式 */
    .control-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }

    .control-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }

    input[type="datetime-local"] {
        padding: 5px;
        border: 1px solid var(--border-color, #ccc);
        border-radius: 4px;
        background: var(--input-bg, #fff);
        color: var(--text-color, #333);
        box-sizing: border-box;
    }

    .checkbox-label {
        font-size: 13px;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
        line-height: 1;
    }

    .checkbox-label input {
        margin: 0;
        padding: 0;
        width: 14px;
        height: 14px;
        position: relative;
        top: -1px;
    }

    /* 服务器筛选标签样式 */
    .server-filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
        width: 100%;
        box-sizing: border-box;
    }

    .server-chip {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--chip-bg, #eee);
        color: var(--text-color, #333);
        transition: all 0.2s;
        user-select: none;
    }

    .server-chip.active {
        background: #0069d6;
        color: #fff;
        border-color: #0069d6;
        box-shadow: 0 2px 4px rgba(0, 105, 214, 0.3);
    }

    .server-chip:hover {
        opacity: 0.9;
    }

    /* 丢包率颜色定义 */
    .loss-text {
        margin-left: 2px;
        font-weight: bold;
    }

    .loss-good {
        color: #3ba272;
    }

    .loss-med {
        color: #faad14;
    }

    .loss-bad {
        color: #ff4d4f;
    }

    .server-chip.active .loss-good {
        color: #d9f7be;
    }

    .server-chip.active .loss-med {
        color: #fffb8f;
    }

    .server-chip.active .loss-bad {
        color: #ffccc7;
    }

    /* 深浅模式 CSS 变量 */
    :root {
        --toolbar-bg: #f8f8f8;
        --chart-bg: #fff;
        --border-color: #ddd;
        --text-color: #333;
        --input-bg: #fff;
        --chip-bg: #f0f0f0;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --toolbar-bg: #2a2a2a;
            --chart-bg: #333;
            --border-color: #444;
            --text-color: #eee;
            --input-bg: #444;
            --chip-bg: #444;
        }
    }

    .cbi-button-custom {
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        border: 1px solid transparent;
        transition: all 0.2s;
    }

    .btn-neutral {
        background: #eee;
        color: #333;
    }

    .btn-active {
        background: #0069d6;
        color: #fff;
    }

    @media (prefers-color-scheme: dark) {
        .btn-neutral {
            background: #444;
            color: #eee;
            border-color: #555;
        }
    }

    .status-text {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        margin-left: 10px;
    }
</style>

<h2>
    <%=translate("网络延迟趋势图")%>
</h2>

<div class="toolbar-container">
    <div class="control-row">
        <div class="control-group" id="preset-buttons">
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(1, this)">1小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(6, this)">6小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(12, this)">12小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(24, this)">24小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(168, this)">7天</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(720, this)">1月</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(4320, this)">6月</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(8760, this)">1年</button>
        </div>

        <div class="control-group">
            <label class="checkbox-label">
                <input type="checkbox" id="auto-refresh-check" onchange="toggleAutoRefresh()" checked>
                <span>自动刷新 (10s)</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="clip-peaks-check" onchange="toggleClipping()">
                <span>削峰 (平滑)</span>
            </label>
        </div>
    </div>

    <div class="control-row">
        <div class="control-group">
            <span style="color: var(--text-color); font-size: 13px;">自定义范围:</span>
            <input type="datetime-local" id="start-time">
            <span style="color: var(--text-color);">-</span>
            <input type="datetime-local" id="end-time">
            <button class="cbi-button-custom btn-active" onclick="setCustomTime()">查询</button>
            <span class="status-text" id="status-text">就绪</span>
        </div>
    </div>

    <div class="server-filter-container" id="server-filters">
        <span style="color: var(--text-color); font-size: 13px; padding: 6px 0;">服务器筛选:</span>
    </div>
</div>

<div class="chart-wrapper">
    <div id="main-chart" class="chart-div"></div>
</div>

<script type="text/javascript">
    var api_url = '<%=luci.dispatcher.build_url("admin", "services", "httping", "get_data")%>';
    var myChart = null;
    var cachedData = [];
    var activeServers = new Set();
    
    // 【优化】从 UCI 读取服务器顺序
    var serverOrder = [
        <%
            local uci = require "luci.model.uci".cursor()
            local servers = {}
            uci:foreach("httping", "server", function(s)
                if s.name then
                    table.insert(servers, '"' .. s.name:gsub('"', '\\"') .. '"')
                end
            end)
            write(table.concat(servers, ","))
        %>
    ];

    var refreshTimer = null;
    var currentRelativeHours = 12;
    var isCustomMode = false;
    var isClippingMode = false;

    var colorPalette = [
        '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'
    ];

    function isDarkMode() { return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }

    function getChartTheme() {
        var isDark = isDarkMode();
        return {
            textColor: isDark ? '#eee' : '#333',
            lineColor: isDark ? '#555' : '#ccc',
            splitLine: isDark ? '#444' : '#eee',
            tooltipBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)'
        };
    }

    function initChart() {
        var chartDom = document.getElementById('main-chart');
        if (myChart != null && myChart != "" && myChart != undefined) {
            myChart.dispose();
        }
        myChart = echarts.init(chartDom);

        if (window.ResizeObserver) {
            var ro = new ResizeObserver(function (entries) {
                myChart.resize();
            });
            ro.observe(chartDom);
            ro.observe(document.querySelector('.chart-wrapper'));
        } else {
            setTimeout(function () { myChart.resize(); }, 500);
        }
    }

    // 增加 preserveZoom 参数
    function processAndRender(rawData, preserveZoom) {
        cachedData = rawData || [];

        var groupedData = {};
        var lossData = {};
        var serverStats = {};

        var rawGrouped = {};
        cachedData.forEach(function (item) {
            if (!rawGrouped[item.server_name]) rawGrouped[item.server_name] = [];
            rawGrouped[item.server_name].push(item.duration);

            if (!serverStats[item.server_name]) serverStats[item.server_name] = { total: 0, loss: 0 };
            serverStats[item.server_name].total++;
            if (item.duration === null) serverStats[item.server_name].loss++;
        });

        var thresholds = {};
        if (isClippingMode) {
            Object.keys(rawGrouped).forEach(function (name) {
                var values = rawGrouped[name].filter(v => v !== null).sort((a, b) => a - b);
                if (values.length > 0) {
                    var idx = Math.floor(values.length * 0.95);
                    thresholds[name] = values[idx];
                } else {
                    thresholds[name] = 9999;
                }
            });
        }

        cachedData.forEach(function (item) {
            if (!groupedData[item.server_name]) {
                groupedData[item.server_name] = [];
                lossData[item.server_name] = [];
            }

            if (item.duration === null) {
                lossData[item.server_name].push([item.timestamp * 1000, 0]);
            } else {
                var finalDuration = item.duration;
                if (isClippingMode && thresholds[item.server_name] && finalDuration > thresholds[item.server_name]) {
                    groupedData[item.server_name].push({
                        value: [item.timestamp * 1000, thresholds[item.server_name]],
                        rawVal: finalDuration
                    });
                } else {
                    groupedData[item.server_name].push([item.timestamp * 1000, finalDuration]);
                }
            }
        });

        renderFilterChips(serverStats);
        updateChartDisplay(groupedData, lossData, preserveZoom);
    }

    function renderFilterChips(stats) {
        var container = document.getElementById('server-filters');

        container.innerHTML = '<span style="color: var(--text-color); font-size: 13px; padding: 6px 0;">服务器筛选:</span>';

        // 【优化】按配置顺序遍历
        serverOrder.forEach(function (name) {
            if (!stats[name]) return; // 如果没有该服务器的数据，跳过

            var total = stats[name].total;
            var lossVal = total > 0 ? (stats[name].loss / total * 100) : 0;
            var lossRateStr = lossVal.toFixed(2);

            var chip = document.createElement('div');

            chip.className = 'server-chip ' + (activeServers.has(name) ? 'active' : '');
            chip.onclick = function () { toggleServer(name, this); };

            var badgeClass = 'loss-good';
            if (lossVal > 10) {
                badgeClass = 'loss-bad';
            } else if (lossVal >= 5) {
                badgeClass = 'loss-med';
            }

            chip.innerHTML = `${name}<span class="loss-text ${badgeClass}">(${lossRateStr}%)</span>`;

            container.appendChild(chip);
        });
        
        // 处理可能存在的未在配置中但有数据的旧数据（虽然少见）
        Object.keys(stats).forEach(function(name) {
             if (serverOrder.indexOf(name) === -1) {
                  // ... logic to render unknown servers if needed, or just ignore
             }
        });
    }

    function toggleServer(name, element) {
        if (activeServers.has(name)) {
            activeServers.delete(name);
            element.classList.remove('active');
        } else {
            activeServers.add(name);
            element.classList.add('active');
        }
        // 切换服务器时，保持当前缩放状态，体验更好
        processAndRender(cachedData, true);
    }

    function toggleClipping() {
        var checkbox = document.getElementById('clip-peaks-check');
        isClippingMode = checkbox.checked;
        // 切换削峰时，保持缩放
        processAndRender(cachedData, true);
    }

    // 核心修改：增加 preserveZoom 参数
    function updateChartDisplay(groupedData, lossData, preserveZoom) {
        var theme = getChartTheme();
        var seriesList = [];
        var legendData = [];
        var colorIdx = 0;

        var isFilterMode = activeServers.size > 0;

        // 【优化】按配置顺序生成图表数据
        serverOrder.forEach(function (serverName) {
            if (!groupedData[serverName]) return; // 无数据跳过
            if (isFilterMode && !activeServers.has(serverName)) return;

            legendData.push(serverName);
            var currentColor = colorPalette[colorIdx % colorPalette.length];

            seriesList.push({
                name: serverName,
                type: 'line',
                connectNulls: false,
                showSymbol: false,
                smooth: true,
                sampling: 'lttb',
                itemStyle: { color: currentColor },
                data: groupedData[serverName]
            });

            if (lossData[serverName] && lossData[serverName].length > 0) {
                seriesList.push({
                    name: serverName + ' (丢包)',
                    type: 'scatter',
                    symbol: 'emptyCircle',
                    symbolSize: 6,
                    itemStyle: {
                        color: '#ff4d4f',
                        borderWidth: 2
                    },
                    data: lossData[serverName],
                    showInLegend: false,
                    tooltip: {
                        formatter: function (params) {
                            return `${params.marker}${serverName}: <b>丢包</b><br/>${params.axisValueLabel}`;
                        }
                    },
                    z: 10
                });
            }

            colorIdx++;
        });

        if (seriesList.length === 0 && isFilterMode) {
            // silent
        }

        // 【关键逻辑】获取当前缩放状态
        var startZoom = 0;
        var endZoom = 100;
        if (preserveZoom && myChart) {
            var currentOpt = myChart.getOption();
            if (currentOpt && currentOpt.dataZoom && currentOpt.dataZoom.length > 0) {
                startZoom = currentOpt.dataZoom[0].start;
                endZoom = currentOpt.dataZoom[0].end;
            }
        }

        var option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                backgroundColor: theme.tooltipBg,
                textStyle: { color: theme.textColor },
                formatter: function (params) {
                    var html = params[0].axisValueLabel + '<br/>';
                    params.forEach(item => {
                        if (item.seriesType === 'line') {
                            var val, displayVal;

                            if (typeof item.data === 'object' && item.data.rawVal !== undefined) {
                                val = item.data.value[1];
                                displayVal = val.toFixed(1) + ' ms <span style="color:#aaa;font-size:11px;">(已削峰)</span>';
                            } else {
                                val = item.value[1];
                                displayVal = val !== null ? val.toFixed(1) + ' ms' : '<span style="color:#ff4d4f;font-weight:bold;">丢包</span>';
                            }

                            var colorSpan = `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>`;
                            html += `${colorSpan}${item.seriesName}: ${displayVal}<br/>`;
                        }
                    });
                    return html;
                }
            },
            legend: {
                data: legendData,
                bottom: 0,
                textStyle: { color: theme.textColor }
            },
            grid: {
                left: '10', right: '30', top: '40', bottom: '10%',
                containLabel: true
            },
            xAxis: {
                type: 'time',
                boundaryGap: false,
                axisLabel: { color: theme.textColor },
                axisLine: { lineStyle: { color: theme.lineColor } },
                splitLine: { show: false }
            },
            yAxis: {
                type: 'value',
                scale: true,
                axisLabel: { color: theme.textColor, formatter: '{value} ms' },
                splitLine: { lineStyle: { color: theme.splitLine } },
                // 【优化】削峰模式下，强制扩大Y轴范围以平滑曲线
                min: function(value) {
                    if (isClippingMode) {
                        return Math.max(0, value.min - (value.max - value.min) * 2);
                    }
                    return value.min;
                },
                max: function(value) {
                    if (isClippingMode) {
                        return value.max + (value.max - value.min) * 2;
                    }
                    return value.max;
                }
            },
            // 【关键逻辑】应用缩放状态
            dataZoom: [
                { type: 'inside', start: startZoom, end: endZoom },
                { type: 'slider', start: startZoom, end: endZoom, bottom: 25, height: 20 }
            ],
            series: seriesList
        };

        myChart.setOption(option, true);
    }

    // 增加 isSilent 和 isRefresh 参数
    // isRefresh = true 代表是自动刷新或局部更新，需要保持 Zoom
    function fetchData(startTs, endTs, isSilent) {
        if (!myChart) initChart();

        if (!isSilent) {
            myChart.showLoading({ text: '加载数据中...', color: '#0069d6', textColor: getChartTheme().textColor });
            document.getElementById('status-text').innerText = "加载中...";
        }

        fetch(api_url + '?start=' + startTs + '&end=' + endTs)
            .then(res => res.json())
            .then(json => {
                document.getElementById('status-text').innerText = "更新于 " + new Date().toLocaleTimeString();
                if (!isSilent) myChart.hideLoading();
                // 关键点：如果是静默刷新(自动刷新)，则传入 true 以保持 Zoom
                processAndRender(json, isSilent);
            })
            .catch(err => {
                console.error(err);
                document.getElementById('status-text').innerText = "加载失败";
                if (!isSilent) myChart.hideLoading();
            });
    }

    function setRelativeTime(hours, btnElement) {
        isCustomMode = false;
        currentRelativeHours = hours;

        var buttons = document.querySelectorAll('#preset-buttons button');
        buttons.forEach(b => { b.classList.remove('btn-active'); b.classList.add('btn-neutral'); });
        if (btnElement) { btnElement.classList.remove('btn-neutral'); btnElement.classList.add('btn-active'); }

        // 切换时间段时，通常希望重置视图，所以 isSilent=false
        performQuery(false);
    }

    function setCustomTime() {
        isCustomMode = true;
        var buttons = document.querySelectorAll('#preset-buttons button');
        buttons.forEach(b => { b.classList.remove('btn-active'); b.classList.add('btn-neutral'); });
        performQuery(false);
    }

    function performQuery(isSilent) {
        var start, end;
        if (isCustomMode) {
            var startVal = document.getElementById('start-time').value;
            var endVal = document.getElementById('end-time').value;
            if (!startVal || !endVal) return;
            start = Math.floor(new Date(startVal).getTime() / 1000);
            end = Math.floor(new Date(endVal).getTime() / 1000);
        } else {
            end = Math.floor(Date.now() / 1000);
            start = end - (currentRelativeHours * 3600);

            var toLocalISO = function (ts) {
                var d = new Date(ts * 1000);
                var offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().slice(0, 16);
            };
            document.getElementById('start-time').value = toLocalISO(start);
            document.getElementById('end-time').value = toLocalISO(end);
        }
        fetchData(start, end, isSilent);
    }

    function toggleAutoRefresh() {
        var checkbox = document.getElementById('auto-refresh-check');
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        if (checkbox.checked) {
            refreshTimer = setInterval(function () {
                // 自动刷新：传入 true (isSilent)，在 fetchData 中会透传给 processAndRender 开启 preserveZoom
                performQuery(true);
            }, 10000);
        }
    }

    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (myChart) performQuery(true);
    });

    window.addEventListener('resize', function () { if (myChart) myChart.resize(); });

    document.addEventListener('DOMContentLoaded', function () {
        initChart();
        var buttons = document.querySelectorAll('#preset-buttons button');
        if (buttons.length > 2) {
            setRelativeTime(12, buttons[2]);
        } else {
            setRelativeTime(1, buttons[0]);
        }
        toggleAutoRefresh();
    });
</script>
<%+footer%>