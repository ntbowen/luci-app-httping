<%+header%>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        /* 容器样式 */
        .toolbar-container {
            background: var(--toolbar-bg, #f8f8f8);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color, #ddd);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-wrapper {
            background: var(--chart-bg, #fff);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color, #ddd);
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .chart-div {
            width: 100%;
            height: 500px;
        }

        /* 按钮组与输入框样式 */
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        input[type="datetime-local"] {
            padding: 5px;
            border: 1px solid var(--border-color, #ccc);
            border-radius: 4px;
            background: var(--input-bg, #fff);
            color: var(--text-color, #333);
        }

        /* 服务器筛选标签样式 */
        .server-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .server-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--chip-bg, #eee);
            color: var(--text-color, #333);
            transition: all 0.2s;
            user-select: none;
        }

        /* 选中状态 */
        .server-chip.active {
            background: #0069d6;
            color: #fff;
            border-color: #0069d6;
            box-shadow: 0 2px 4px rgba(0, 105, 214, 0.3);
        }

        .server-chip:hover {
            opacity: 0.9;
        }

        /* 丢包率颜色定义 */
        .loss-text {
            margin-left: 2px;
            font-weight: bold;
        }

        .loss-good {
            color: #3ba272;
        }

        .loss-med {
            color: #faad14;
        }

        .loss-bad {
            color: #ff4d4f;
        }

        .server-chip.active .loss-good {
            color: #d9f7be;
        }

        .server-chip.active .loss-med {
            color: #fffb8f;
        }

        .server-chip.active .loss-bad {
            color: #ffccc7;
        }

        /* 深浅模式 CSS 变量 */
        :root {
            --toolbar-bg: #f8f8f8;
            --chart-bg: #fff;
            --border-color: #ddd;
            --text-color: #333;
            --input-bg: #fff;
            --chip-bg: #f0f0f0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --toolbar-bg: #2a2a2a;
                --chart-bg: #333;
                --border-color: #444;
                --text-color: #eee;
                --input-bg: #444;
                --chip-bg: #444;
            }
        }

        .cbi-button-custom {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .btn-neutral {
            background: #eee;
            color: #333;
        }

        .btn-active {
            background: #0069d6;
            color: #fff;
        }

        @media (prefers-color-scheme: dark) {
            .btn-neutral {
                background: #444;
                color: #eee;
                border-color: #555;
            }
        }

        .status-text {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
            margin-left: 10px;
        }
    </style>

    <h2>
        <%=translate("网络延迟趋势图")%>
    </h2>

    <div class="toolbar-container">
        <div class="control-row">
            <div class="control-group" id="preset-buttons">
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(1, this)">1小时</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(6, this)">6小时</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(12, this)">12小时</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(24, this)">24小时</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(168, this)">7天</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(720, this)">1月</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(4320, this)">6月</button>
                <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(8760, this)">1年</button>
            </div>
        </div>

        <div class="control-row">
            <div class="control-group">
                <span style="color: var(--text-color); font-size: 13px;">自定义范围:</span>
                <input type="datetime-local" id="start-time">
                <span style="color: var(--text-color);">-</span>
                <input type="datetime-local" id="end-time">
                <button class="cbi-button-custom btn-active" onclick="setCustomTime()">查询</button>
                <span class="status-text" id="status-text">就绪</span>
            </div>
        </div>

        <div class="server-filter-container" id="server-filters">
            <span style="color: var(--text-color); font-size: 13px; padding: 6px 0;">服务器筛选:</span>
        </div>
    </div>

    <div class="chart-wrapper">
        <div id="main-chart" class="chart-div"></div>
    </div>

    <script type="text/javascript">
        var api_url = '<%=luci.dispatcher.build_url("admin", "services", "httping", "get_data")%>';
        var myChart = null;
        var cachedData = [];
        var activeServers = new Set();

        var colorPalette = [
            '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'
        ];

        function isDarkMode() { return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }

        function getChartTheme() {
            var isDark = isDarkMode();
            return {
                textColor: isDark ? '#eee' : '#333',
                lineColor: isDark ? '#555' : '#ccc',
                splitLine: isDark ? '#444' : '#eee',
                tooltipBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)'
            };
        }

        function initChart() {
            if (myChart != null && myChart != "" && myChart != undefined) {
                myChart.dispose();
            }
            myChart = echarts.init(document.getElementById('main-chart'));
        }

        function processAndRender(rawData) {
            cachedData = rawData || [];

            var groupedData = {};
            var lossData = {}; // 存储丢包点的数据
            var serverStats = {};

            cachedData.forEach(function (item) {
                if (!groupedData[item.server_name]) {
                    groupedData[item.server_name] = [];
                    lossData[item.server_name] = [];
                    serverStats[item.server_name] = { total: 0, loss: 0 };
                }

                serverStats[item.server_name].total++;

                if (item.duration === null) {
                    serverStats[item.server_name].loss++;
                    // 丢包点：为了在图表上显示，赋值为 0 (Y轴底部)
                    lossData[item.server_name].push([item.timestamp * 1000, 0]);
                }

                // 正常折线数据
                groupedData[item.server_name].push([item.timestamp * 1000, item.duration]);
            });

            renderFilterChips(serverStats);
            updateChartDisplay(groupedData, lossData);
        }

        function renderFilterChips(stats) {
            var container = document.getElementById('server-filters');

            container.innerHTML = '<span style="color: var(--text-color); font-size: 13px; padding: 6px 0;">服务器筛选:</span>';

            Object.keys(stats).forEach(function (name) {
                var total = stats[name].total;
                var lossVal = total > 0 ? (stats[name].loss / total * 100) : 0;
                var lossRateStr = lossVal.toFixed(2);

                var chip = document.createElement('div');

                chip.className = 'server-chip ' + (activeServers.has(name) ? 'active' : '');
                chip.onclick = function () { toggleServer(name, this); };

                var badgeClass = 'loss-good';
                if (lossVal > 10) {
                    badgeClass = 'loss-bad';
                } else if (lossVal >= 5) {
                    badgeClass = 'loss-med';
                }

                chip.innerHTML = `${name}<span class="loss-text ${badgeClass}">(${lossRateStr}%)</span>`;

                container.appendChild(chip);
            });
        }

        function toggleServer(name, element) {
            if (activeServers.has(name)) {
                activeServers.delete(name);
                element.classList.remove('active');
            } else {
                activeServers.add(name);
                element.classList.add('active');
            }

            // 重新构建数据 (需要重新分离折线数据和丢包数据)
            var groupedData = {};
            var lossData = {};
            cachedData.forEach(function (item) {
                if (!groupedData[item.server_name]) {
                    groupedData[item.server_name] = [];
                    lossData[item.server_name] = [];
                }
                if (item.duration === null) {
                    lossData[item.server_name].push([item.timestamp * 1000, 0]);
                }
                groupedData[item.server_name].push([item.timestamp * 1000, item.duration]);
            });

            updateChartDisplay(groupedData, lossData);
        }

        function updateChartDisplay(groupedData, lossData) {
            var theme = getChartTheme();
            var seriesList = [];
            var legendData = [];
            var colorIdx = 0;

            var isFilterMode = activeServers.size > 0;

            Object.keys(groupedData).forEach(function (serverName) {
                if (isFilterMode && !activeServers.has(serverName)) return;

                legendData.push(serverName);
                var currentColor = colorPalette[colorIdx % colorPalette.length];

                // 1. 折线图 Series
                seriesList.push({
                    name: serverName,
                    type: 'line',
                    connectNulls: false,
                    showSymbol: false,
                    smooth: true,
                    sampling: 'lttb',
                    itemStyle: { color: currentColor },
                    data: groupedData[serverName]
                });

                // 2. 丢包散点 Series (空心红点)
                if (lossData[serverName] && lossData[serverName].length > 0) {
                    seriesList.push({
                        name: serverName + ' (丢包)', // 这个名字主要用于内部逻辑，图例不显示
                        type: 'scatter',
                        symbol: 'emptyCircle',
                        symbolSize: 6, // 小圆点大小
                        itemStyle: {
                            color: '#ff4d4f', // 红色
                            borderWidth: 2
                        },
                        data: lossData[serverName],
                        showInLegend: false, // 不在图例中显示单独的丢包项，保持界面整洁
                        tooltip: {
                            formatter: function (params) {
                                return `${params.marker}${serverName}: <b>丢包</b><br/>${params.axisValueLabel}`;
                            }
                        },
                        z: 10 // 确保显示在折线上层
                    });
                }

                colorIdx++;
            });

            if (seriesList.length === 0 && isFilterMode) {
                myChart.showLoading({ text: '未选中任何服务器', color: '#0069d6', textColor: theme.textColor, maskColor: 'transparent' });
                return;
            } else if (seriesList.length === 0 && !isFilterMode) {
                myChart.showLoading({ text: '暂无数据', color: '#0069d6', textColor: theme.textColor, maskColor: 'transparent' });
                return;
            } else {
                myChart.hideLoading();
            }

            var option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: theme.tooltipBg,
                    textStyle: { color: theme.textColor },
                    formatter: function (params) {
                        var html = params[0].axisValueLabel + '<br/>';
                        // 过滤掉 scatter 类型的 tooltip（已经在 scatter 内部定义了），
                        // 或者在这里统一处理。因为 trigger: axis 会聚合所有点。
                        params.forEach(item => {
                            // 区分折线值和丢包点
                            if (item.seriesType === 'line') {
                                var val = item.value[1];
                                var colorSpan = `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>`;
                                html += `${colorSpan}${item.seriesName}: ${val !== null ? val.toFixed(1) + ' ms' : '<span style="color:#ff4d4f;font-weight:bold;">丢包</span>'}<br/>`;
                            }
                            // Scatter 类型在 axis tooltip 里通常不需要重复显示，除非是多点重合。
                            // 由于折线数据里该点已经是 null (显示为"丢包"或者不显示)，这里可以不处理 scatter
                        });
                        return html;
                    }
                },
                legend: {
                    data: legendData,
                    bottom: 0,
                    textStyle: { color: theme.textColor }
                },
                grid: {
                    left: '10', right: '30', top: '40', bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'time',
                    boundaryGap: false,
                    axisLabel: { color: theme.textColor },
                    axisLine: { lineStyle: { color: theme.lineColor } },
                    splitLine: { show: false }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    axisLabel: { color: theme.textColor, formatter: '{value} ms' },
                    splitLine: { lineStyle: { color: theme.splitLine } }
                },
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { type: 'slider', start: 0, end: 100, bottom: 25, height: 20 }
                ],
                series: seriesList
            };

            myChart.setOption(option, true);
        }

        function fetchData(startTs, endTs) {
            if (!myChart) initChart();
            myChart.showLoading({ text: '加载数据中...', color: '#0069d6', textColor: getChartTheme().textColor });
            document.getElementById('status-text').innerText = "加载中...";

            fetch(api_url + '?start=' + startTs + '&end=' + endTs)
                .then(res => res.json())
                .then(json => {
                    document.getElementById('status-text').innerText = "更新于 " + new Date().toLocaleTimeString();
                    myChart.hideLoading();
                    processAndRender(json);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('status-text').innerText = "加载失败";
                    myChart.hideLoading();
                });
        }

        function setRelativeTime(hours, btnElement) {
            var buttons = document.querySelectorAll('#preset-buttons button');
            buttons.forEach(b => { b.classList.remove('btn-active'); b.classList.add('btn-neutral'); });
            if (btnElement) { btnElement.classList.remove('btn-neutral'); btnElement.classList.add('btn-active'); }

            var end = Math.floor(Date.now() / 1000);
            var start = end - (hours * 3600);

            var toLocalISO = function (ts) {
                var d = new Date(ts * 1000);
                var offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().slice(0, 16);
            };
            document.getElementById('start-time').value = toLocalISO(start);
            document.getElementById('end-time').value = toLocalISO(end);

            fetchData(start, end);
        }

        function setCustomTime() {
            var startVal = document.getElementById('start-time').value;
            var endVal = document.getElementById('end-time').value;
            if (!startVal || !endVal) { alert("请选择开始和结束时间"); return; }
            var startTs = Math.floor(new Date(startVal).getTime() / 1000);
            var endTs = Math.floor(new Date(endVal).getTime() / 1000);
            if (startTs >= endTs) { alert("开始时间必须早于结束时间"); return; }

            var buttons = document.querySelectorAll('#preset-buttons button');
            buttons.forEach(b => { b.classList.remove('btn-active'); b.classList.add('btn-neutral'); });
            fetchData(startTs, endTs);
        }

        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (myChart) {
                var groupedData = {};
                var lossData = {};
                cachedData.forEach(function (item) {
                    if (!groupedData[item.server_name]) {
                        groupedData[item.server_name] = [];
                        lossData[item.server_name] = [];
                    }
                    if (item.duration === null) lossData[item.server_name].push([item.timestamp * 1000, 0]);
                    groupedData[item.server_name].push([item.timestamp * 1000, item.duration]);
                });
                updateChartDisplay(groupedData, lossData);
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            initChart();
            var buttons = document.querySelectorAll('#preset-buttons button');
            if (buttons.length > 2) {
                setRelativeTime(12, buttons[2]);
            } else {
                setRelativeTime(1, buttons[0]);
            }
        });

        window.addEventListener('resize', function () { if (myChart) myChart.resize(); });
    </script>
    <%+footer%>