<%+header%>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<style>
    .toolbar-container {
        background: var(--toolbar-bg, #f8f8f8);
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color, #ddd);
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        justify-content: space-between;
    }

    .chart-wrapper {
        background: var(--chart-bg, #fff);
        padding: 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color, #ddd);
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .chart-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        padding-left: 5px;
        border-left: 4px solid #0069d6;
        color: var(--text-color, #333);
    }

    .chart-div {
        width: 100%;
        height: 300px;
    }

    .control-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    input[type="datetime-local"] {
        padding: 5px;
        border: 1px solid var(--border-color, #ccc);
        border-radius: 4px;
        background: var(--input-bg, #fff);
        color: var(--text-color, #333);
    }

    :root {
        --toolbar-bg: #f8f8f8;
        --chart-bg: #fff;
        --border-color: #ddd;
        --text-color: #333;
        --input-bg: #fff;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --toolbar-bg: #2a2a2a;
            --chart-bg: #333;
            --border-color: #444;
            --text-color: #eee;
            --input-bg: #444;
        }
    }

    .cbi-button-custom {
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        border: 1px solid transparent;
        transition: all 0.2s;
    }

    .btn-neutral {
        background: #eee;
        color: #333;
    }

    .btn-active {
        background: #0069d6;
        color: #fff;
    }

    @media (prefers-color-scheme: dark) {
        .btn-neutral {
            background: #444;
            color: #eee;
            border-color: #555;
        }
    }

    .status-text {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        margin-left: 10px;
    }
</style>

<h2>
    <%=translate("网络延迟趋势图")%>
</h2>

<div class="toolbar-container">
    <div style="display:flex; flex-direction:column; gap:10px; width:100%;">
        <div class="control-group" id="preset-buttons">
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(1, this)">1小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(6, this)">6小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(24, this)">24小时</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(168, this)">7天</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(720, this)">1月</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(2160, this)">3月</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(4320, this)">6月</button>
            <button class="cbi-button-custom btn-neutral" onclick="setRelativeTime(8760, this)">1年</button>
        </div>
        <div class="control-group" style="border-top: 1px solid var(--border-color); padding-top: 10px;">
            <span style="color: var(--text-color); font-size: 13px;">自定义范围:</span>
            <input type="datetime-local" id="start-time">
            <span style="color: var(--text-color);">-</span>
            <input type="datetime-local" id="end-time">
            <button class="cbi-button-custom btn-active" onclick="setCustomTime()">查询</button>
            <span class="status-text" id="status-text">就绪</span>
        </div>
    </div>
</div>

<div id="charts-container"></div>

<script type="text/javascript">
    var api_url = '<%=luci.dispatcher.build_url("admin", "services", "httping", "get_data")%>';
    var chartsInstances = [];

    function isDarkMode() { return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }

    function getChartTheme() {
        var isDark = isDarkMode();
        return {
            textColor: isDark ? '#eee' : '#333',
            lineColor: isDark ? '#555' : '#ccc',
            splitLine: isDark ? '#444' : '#eee',
            tooltipBg: isDark ? 'rgba(50,50,50,0.9)' : 'rgba(255,255,255,0.9)',
            seriesColor: '#0069d6'
        };
    }

    function renderCharts(rawData) {
        var container = document.getElementById('charts-container');
        container.innerHTML = "";
        chartsInstances.forEach(c => c.dispose());
        chartsInstances = [];

        if (!rawData || rawData.length === 0) {
            container.innerHTML = '<div style="padding:40px; text-align:center; color:gray;">当前时间段暂无数据。</div>';
            return;
        }

        var groupedData = {};
        rawData.forEach(function (item) {
            if (!groupedData[item.server_name]) groupedData[item.server_name] = [];
            groupedData[item.server_name].push([item.timestamp * 1000, item.duration]);
        });

        var theme = getChartTheme();
        Object.keys(groupedData).forEach(function (serverName) {
            var wrapper = document.createElement('div');
            wrapper.className = 'chart-wrapper';
            var title = document.createElement('div');
            title.className = 'chart-title';
            title.innerText = serverName;
            var chartDiv = document.createElement('div');
            chartDiv.className = 'chart-div';
            wrapper.appendChild(title);
            wrapper.appendChild(chartDiv);
            container.appendChild(wrapper);

            var myChart = echarts.init(chartDiv);
            chartsInstances.push(myChart);
            var option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: theme.tooltipBg,
                    textStyle: { color: theme.textColor },
                    formatter: function (params) {
                        var val = params[0].value[1];
                        return params[0].axisValueLabel + '<br/>' +
                            params[0].marker + (val !== null ? val.toFixed(1) + ' ms' : '超时');
                    }
                },
                grid: { left: '50', right: '20', top: '10', bottom: '30' },
                xAxis: {
                    type: 'time', boundaryGap: false,
                    axisLabel: { color: theme.textColor },
                    axisLine: { lineStyle: { color: theme.lineColor } },
                    splitLine: { show: false }
                },
                yAxis: {
                    type: 'value', scale: true,
                    axisLabel: { color: theme.textColor, formatter: '{value} ms' },
                    splitLine: { lineStyle: { color: theme.splitLine } }
                },
                dataZoom: [{ type: 'inside', start: 0, end: 100 }, { type: 'slider', start: 0, end: 100, bottom: 0, height: 20 }],
                series: [{
                    name: serverName, type: 'line', connectNulls: false, showSymbol: false, smooth: true, sampling: 'lttb',
                    itemStyle: { color: theme.seriesColor },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(0, 105, 214, 0.3)' },
                            { offset: 1, color: 'rgba(0, 105, 214, 0.01)' }
                        ])
                    },
                    data: groupedData[serverName]
                }]
            };
            myChart.setOption(option);
        });
    }

    function fetchData(startTs, endTs) {
        document.getElementById('status-text').innerText = "加载中...";
        fetch(api_url + '?start=' + startTs + '&end=' + endTs)
            .then(res => res.json()).then(json => {
                document.getElementById('status-text').innerText = "更新于 " + new Date().toLocaleTimeString();
                renderCharts(json);
            }).catch(err => { console.error(err); document.getElementById('status-text').innerText = "加载失败"; });
    }

    function setRelativeTime(hours, btnElement) {
        var buttons = document.querySelectorAll('#preset-buttons button');
        buttons.forEach(b => { b.classList.remove('btn-active'); b.classList.add('btn-neutral'); });
        if (btnElement) { btnElement.classList.remove('btn-neutral'); btnElement.classList.add('btn-active'); }
        var end = Math.floor(Date.now() / 1000);
        var start = end - (hours * 3600);
        var toLocalISO = function (ts) {
            var d = new Date(ts * 1000);
            var offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().slice(0, 16);
        };
        document.getElementById('start-time').value = toLocalISO(start);
        document.getElementById('end-time').value = toLocalISO(end);
        fetchData(start, end);
    }

    function setCustomTime() {
        var startVal = document.getElementById('start-time').value;
        var endVal = document.getElementById('end-time').value;
        if (!startVal || !endVal) { alert("请选择开始和结束时间"); return; }
        var startTs = Math.floor(new Date(startVal).getTime() / 1000);
        var endTs = Math.floor(new Date(endVal).getTime() / 1000);
        if (startTs >= endTs) { alert("开始时间必须早于结束时间"); return; }
        var buttons = document.querySelectorAll('#preset-buttons button');
        buttons.forEach(b => { b.classList.remove('btn-active'); b.classList.add('btn-neutral'); });
        fetchData(startTs, endTs);
    }

    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) { setCustomTime(); });
    document.addEventListener('DOMContentLoaded', function () {
        var firstBtn = document.querySelector('#preset-buttons button');
        setRelativeTime(1, firstBtn);
    });
    window.addEventListener('resize', function () { chartsInstances.forEach(c => c.resize()); });
</script>
<%+footer%>